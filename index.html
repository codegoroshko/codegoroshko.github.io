<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>–ö–æ–¥–µ–≥–æ—Ä–æ—à–∫–æ - –ê–ª–≥–æ—Ä–∏—Ç–º—ñ—á–Ω–∞ –†–ü–ì</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
          xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è (Drag-and-Drop) */
        .drag-placeholder {
            height: 50px;
            background: rgba(139, 92, 246, 0.2);
            border: 2px dashed rgb(139, 92, 246);
            border-radius: 0.5rem;
            margin-bottom: 8px; /* –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î margin-bottom .program-block */
            margin-top: -1px;
            pointer-events: none;
        }

        .dragging {
            opacity: 0.5;
            transform: scale(1.05);
            transition: none !important;
        }
        
        /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç –ø—ñ–¥ —á–∞—Å touch-drag */
        .program-block.dragging {
            opacity: 0.2;
        }

        .program-block, .block {
            -webkit-user-select: none;
            user-select: none;
            touch-action: none; /* –ö–µ—Ä—É—î—Ç—å—Å—è JS –¥–ª—è D&D */
            will-change: transform;
        }

        .program-block i, .block i {
            pointer-events: none;
        }
        
        /* –ó–º—ñ–Ω–µ–Ω–æ –∫—É—Ä—Å–æ—Ä –¥–ª—è –ø–∞–ª—ñ—Ç—Ä–∏, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ "click" —ñ "drag" */
        .block {
             cursor: grab;
        }
        .block:active {
            cursor: grabbing;
        }

        /* –ü–æ–∫—Ä–∞—â–µ–Ω—ñ –∞–Ω—ñ–º–∞—Ü—ñ—ó */
        .fade-in {
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .level-complete {
            animation: celebrate 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            75% { transform: scale(1.1) rotate(5deg); }
        }

        /* –ü—É–ª—å—Å –¥–ª—è –ø—ñ–¥–∫–∞–∑–æ–∫ */
        .pulse-hint {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞ —Å—ñ—Ç–∫–∞ */
        .grid {
            max-width: min(90vw, 500px);
            aspect-ratio: 1;
        }

        .cell {
            min-height: 0;
            font-size: clamp(1.5rem, 4vw, 2rem);
        }

        /* –ö–Ω–æ–ø–∫–∏ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö */
        button {
            min-height: 44px;
            min-width: 44px;
        }

        /* –ü–ª–∞–≤–Ω–∏–π —Å–∫—Ä–æ–ª */
        .program-area {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–æ—è–≤–∏ tutorial */
        .tutorial-enter {
            animation: tutorialEnter 0.4s ease-out;
        }

        @keyframes tutorialEnter {
            from { 
                opacity: 0; 
                transform: scale(0.9) translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        /* –ü—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ tutorial */
        .tutorial-highlight {
            position: relative;
            z-index: 45;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.5), 0 0 30px rgba(99, 102, 241, 0.3);
            animation: highlightPulse 2s ease-in-out infinite;
        }

        @keyframes highlightPulse {
            0%, 100% { box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.5), 0 0 30px rgba(99, 102, 241, 0.3); }
            50% { box-shadow: 0 0 0 8px rgba(99, 102, 241, 0.7), 0 0 40px rgba(99, 102, 241, 0.5); }
        }

        /* –ó–∞—Ç–µ–º–Ω–µ–Ω–Ω—è –¥–ª—è tutorial */
        .tutorial-dimmed {
            opacity: 0.3;
            pointer-events: none;
        }

        /* Haptic feedback */
        .haptic-light {
            transition: transform 0.05s;
        }

        .haptic-light:active {
            transform: scale(0.98);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ –≤—ñ–¥—Å—Ç—É–ø–∏ */
        @media (max-width: 640px) {
            .container {
                padding: 1rem;
            }
            
            .block, .program-block {
                font-size: 0.875rem;
            }
        }

        /* Landscape –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—è */
        @media (max-width: 768px) and (orientation: landscape) {
            .game-area {
                flex-direction: row !important;
            }
            
            .grid {
                max-width: 45vh;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 p-2 md:p-4 min-h-screen">

    <!-- –ù–ê–†–ê–¢–ò–í–ù–Ü –ï–ö–†–ê–ù–ò –¢–£–¢–û–†–Ü–ê–õ–£ -->
    <div id="storyScreen1" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-gradient-to-br from-amber-50 to-orange-100 rounded-2xl shadow-2xl max-w-lg p-8 text-center tutorial-enter">
            <div class="text-7xl mb-6">üí™</div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">–õ–µ–≥–µ–Ω–¥–∞ –ø—Ä–æ –ö–æ—Ç–∏–≥–æ—Ä–æ—à–∫–∞</h2>
            <p class="text-lg text-gray-700 leading-relaxed mb-6">
                –î–∞–≤–Ω–∏–º-–¥–∞–≤–Ω–æ –∂–∏–≤ —Ö–ª–æ–ø—á–∏–∫ –Ω–∞ —ñ–º'—è <strong>–ö–æ—Ç–∏–≥–æ—Ä–æ—à–æ–∫</strong>. 
                –í—ñ–Ω –±—É–≤ —Ç–∞–∫–∏–º —Å–∏–ª—å–Ω–∏–º, —â–æ –º—ñ–≥ –ø–µ—Ä–µ–º–æ–≥—Ç–∏ –±—É–¥—å-—è–∫–æ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞ –æ–¥–Ω—ñ—î—é —Ä—É–∫–æ—é!
            </p>
            <p class="text-base text-gray-600 italic mb-6">
                –ö–æ—Ç–∏–≥–æ—Ä–æ—à–æ–∫ –∑–¥–æ–ª–∞–≤ –ó–º—ñ—è –ì–æ—Ä–∏–Ω–∏—á–∞, –ø–µ—Ä–µ–º—ñ–≥ –ß—É–¥–æ-–Æ–¥–æ —ñ –≤—Ä—è—Ç—É–≤–∞–≤ –±–∞–≥–∞—Ç–æ —Å—ñ–ª –≤—ñ–¥ –ª–∏—Ö–∞...
            </p>
            <button id="story1Next" class="haptic-light w-full py-4 px-8 bg-indigo-600 text-white font-bold text-lg rounded-xl hover:bg-indigo-700 transition shadow-lg">
                –î–∞–ª—ñ ‚è©
            </button>
        </div>
    </div>

    <div id="storyScreen2" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-2xl shadow-2xl max-w-lg p-8 text-center tutorial-enter">
            <div class="text-7xl mb-6">üßô‚Äç‚ôÇÔ∏è</div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">–ú—É–¥—Ä—ñ—Å—Ç—å —á–∞—Ä—ñ–≤–Ω–∏–∫–∞</h2>
            <div class="bg-white/70 rounded-xl p-4 mb-6">
                <p class="text-lg text-gray-700 leading-relaxed mb-4">
                    "–ö–æ—Ç–∏–≥–æ—Ä–æ—à–∫—É, —Ç–∏ –¥—É–∂–µ —Å–∏–ª—å–Ω–∏–π! –ê–ª–µ –≤ —Å—É—á–∞—Å–Ω–æ–º—É —Å–≤—ñ—Ç—ñ <strong>—Å–∏–ª–∞ ‚Äì —Ü–µ –Ω–µ –≤—Å–µ</strong>."
                </p>
                <p class="text-xl font-bold text-indigo-600 mb-2">
                    –ù–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–∞ —Å—É–ø–µ—Ä—Å–∏–ª–∞ ‚Äì —Ü–µ –≤–º—ñ–Ω–Ω—è <span class="text-purple-600">–ø–ª–∞–Ω—É–≤–∞—Ç–∏</span> —Ç–∞ <span class="text-purple-600">–∫—Ä–∏—Ç–∏—á–Ω–æ –º–∏—Å–ª–∏—Ç–∏</span>!
                </p>
            </div>
            <div class="text-sm text-gray-600 mb-6 text-left bg-gray-50 rounded-lg p-4">
                <div class="mb-2">‚ùå –î–æ–≤–≥–∏–π —à–ª—è—Ö: 20 –∫—Ä–æ–∫—ñ–≤ ‚Üí üíé</div>
                <div class="text-green-600 font-semibold">‚úÖ –†–æ–∑—É–º–Ω–∏–π —à–ª—è—Ö: 3 –∫—Ä–æ–∫–∏ ‚Üí üíé</div>
            </div>
            <button id="story2Next" class="haptic-light w-full py-4 px-8 bg-purple-600 text-white font-bold text-lg rounded-xl hover:bg-purple-700 transition shadow-lg">
                –•–æ—á—É –Ω–∞–≤—á–∏—Ç–∏—Å—è! üöÄ
            </button>
        </div>
    </div>

    <div id="storyScreen3" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-gradient-to-br from-purple-50 to-pink-100 rounded-2xl shadow-2xl max-w-lg p-8 text-center tutorial-enter">
            <div class="text-7xl mb-6 level-complete">‚ö°</div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">–ù–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –ö–æ–¥–µ–≥–æ—Ä–æ—à–∫–∞</h2>
            <p class="text-lg text-gray-700 leading-relaxed mb-4">
                –ß–∞—Ä—ñ–≤–Ω–∏–∫ —É—Å–º—ñ—Ö–Ω—É–≤—Å—è: "–¢–æ–¥—ñ —Å—Ç–∞–≤–∞–π <strong class="text-indigo-600">–ö–æ–¥–µ–≥–æ—Ä–æ—à–∫–æ–º</strong> ‚Äì –≥–µ—Ä–æ—î–º –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª—ñ–Ω–Ω—è!"
            </p>
            <div class="bg-white/70 rounded-xl p-4 mb-6">
                <p class="text-base text-gray-700 mb-2">
                    <strong>–©–æ —Ç–∞–∫–µ –∞–ª–≥–æ—Ä–∏—Ç–º?</strong>
                </p>
                <p class="text-sm text-gray-600">
                    –¶–µ –ø–æ–∫—Ä–æ–∫–æ–≤–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è, —è–∫ –¥–æ—Å—è–≥—Ç–∏ –º–µ—Ç–∏.<br>
                    –ù–∞–ø—Ä–∏–∫–ª–∞–¥: "–Ü–¥–∏ 3 –∫—Ä–æ–∫–∏ –ø—Ä–∞–≤–æ—Ä—É—á, –ø–æ—Ç—ñ–º 2 –∫—Ä–æ–∫–∏ –≤–Ω–∏–∑"
                </p>
            </div>
            <button id="story3Next" class="haptic-light w-full py-4 px-8 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold text-lg rounded-xl hover:from-indigo-700 hover:to-purple-700 transition shadow-lg">
                –ü–æ—á–Ω—ñ–º–æ –ø—Ä–∏–≥–æ–¥—É! üéÆ
            </button>
        </div>
    </div>

    <!-- –Ü–ù–¢–ï–†–ê–ö–¢–ò–í–ù–ò–ô –¢–£–¢–û–†–Ü–ê–õ (Phase-by-phase) -->
    <div id="tutorialOverlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-40 hidden items-center justify-center p-4">
        <div id="tutorialContent" class="bg-white rounded-2xl shadow-2xl max-w-md p-6 text-center tutorial-enter">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ –¥–∏–Ω–∞–º—ñ—á–Ω–æ –∑–º—ñ–Ω—é–≤–∞—Ç–∏—Å—å -->
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ -->
    <div id="modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 hidden">
        <div id="modalContent" class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-95 opacity-0">
            <div class="p-6 text-center">
                <div id="modalIcon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl"></div>
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-2"></h3>
                <p id="modalMessage" class="text-base text-gray-600 mb-6 whitespace-pre-line"></p>
                <div id="modalButtons" class="flex gap-3 justify-center flex-wrap"></div>
            </div>
        </div>
    </div>

    <!-- –û–°–ù–û–í–ù–ê –ì–†–ê -->
    <div class="container max-w-7xl mx-auto bg-white rounded-2xl p-3 md:p-6 shadow-2xl">
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <h1 class="text-center text-xl md:text-3xl font-bold text-indigo-600 mb-3 md:mb-4">
            <i class="fa-solid fa-code mr-2"></i> –ö–æ–¥–µ–≥–æ—Ä–æ—à–∫–æ
        </h1>
        
        <!-- –ü—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä -->
        <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
            <div id="levelProgressBar" class="level-progress bg-gradient-to-r from-indigo-500 to-purple-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>

        <!-- –í–∏–±—ñ—Ä —Ä—ñ–≤–Ω—è -->
        <div class="level-selector mb-4 text-center">
            <div class="inline-flex items-center gap-2 md:gap-3 bg-gray-100 p-2 md:p-3 rounded-lg">
                <button id="prevLevel" class="haptic-light px-3 md:px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600 transition disabled:opacity-50">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <div class="text-base md:text-lg font-bold">
                    –†—ñ–≤–µ–Ω—å <span id="currentLevel">0.1</span>
                </div>
                <button id="nextLevel" class="haptic-light px-3 md:px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600 transition disabled:opacity-50">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
                <button id="showHint" class="haptic-light px-3 md:px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition" title="–ü—ñ–¥–∫–∞–∑–∫–∞">
                    <i class="fa-solid fa-lightbulb"></i>
                </button>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="flex flex-wrap gap-2 md:gap-4 justify-center mb-4 text-sm md:text-base">
            <div class="stat bg-white py-2 px-3 md:px-5 rounded-lg border-2 border-indigo-500 font-semibold">
                <i class="fa-solid fa-gavel text-gray-600"></i> <span id="weapon">0</span>
            </div>
            <div class="stat bg-white py-2 px-3 md:px-5 rounded-lg border-2 border-red-500 font-semibold">
                <i class="fa-solid fa-heart text-red-500"></i> <span id="strength">15</span>
            </div>
            <div class="stat bg-white py-2 px-3 md:px-5 rounded-lg border-2 border-blue-500 font-semibold">
                <i class="fa-solid fa-location-dot text-blue-500"></i> <span id="position">(0,0)</span>
            </div>
        </div>

        <div class="game-area flex flex-col lg:flex-row gap-4 md:gap-6 mb-4">
            
            <!-- –°—ñ—Ç–∫–∞ -->
            <div class="grid-container flex-shrink-0 mx-auto">
                <div class="grid gap-0.5 bg-gray-300 p-0.5 rounded-lg mb-3 mx-auto"></div>
                <div class="controls flex gap-2 md:gap-3 flex-wrap justify-center">
                    <button class="run-btn haptic-light flex items-center justify-center py-2.5 px-4 font-semibold rounded-lg shadow-md transition-all bg-green-500 text-white hover:bg-green-600">
                        <i class="fa-solid fa-play mr-2"></i> –°—Ç–∞—Ä—Ç
                    </button>
                    <button class="reset-btn haptic-light flex items-center justify-center py-2.5 px-4 font-semibold rounded-lg shadow-md transition-all bg-yellow-400 text-gray-800 hover:bg-yellow-500">
                        <i class="fa-solid fa-arrows-rotate mr-2"></i> –°–∫–∏–Ω—É—Ç–∏
                    </button>
                    <button class="clear-btn haptic-light flex items-center justify-center py-2.5 px-4 font-semibold rounded-lg shadow-md transition-all bg-red-500 text-white hover:bg-red-600">
                        <i class="fa-solid fa-trash mr-2"></i> –û—á–∏—Å—Ç–∏—Ç–∏
                    </button>
                </div>
                <div id="levelInfo" class="info mt-3 p-3 bg-blue-50 border-l-4 border-blue-400 text-blue-700 rounded-md text-xs md:text-sm"></div>
                <div id="stepCounter" class="mt-3 p-2 bg-purple-50 border-l-4 border-purple-400 text-purple-700 rounded-md text-xs md:text-sm text-center font-semibold hidden">
                    –ö—Ä–æ–∫—ñ–≤: <span id="stepCount">0</span>
                </div>
            </div>

            <!-- –ü—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è -->
            <div class="programming-wrapper flex flex-col sm:flex-row flex-1 gap-3 md:gap-4">
                
                <!-- –ü–∞–ª—ñ—Ç—Ä–∞ –∫–æ–º–∞–Ω–¥ -->
                <div class="blocks-area w-full sm:w-[35%] bg-gradient-to-br from-gray-50 to-gray-100 p-3 md:p-4 rounded-lg border-2 border-gray-200">
                    <div class="blocks-title text-base md:text-lg font-bold mb-3 text-gray-700">
                        <i class="fa-solid fa-box-archive mr-2"></i>–ö–æ–º–∞–Ω–¥–∏
                    </div>
                    <div id="commandBlocks" class="flex flex-col gap-2">
                        <div class="block haptic-light" draggable="true" data-command="up">
                            <i class="fa-solid fa-arrow-up w-5"></i> –í–≥–æ—Ä—É
                        </div>
                        <div class="block haptic-light" draggable="true" data-command="down">
                            <i class="fa-solid fa-arrow-down w-5"></i> –í–Ω–∏–∑
                        </div>
                        <div class="block haptic-light" draggable="true" data-command="left">
                            <i class="fa-solid fa-arrow-left w-5"></i> –õ—ñ–≤–æ—Ä—É—á
                        </div>
                        <div class="block haptic-light" draggable="true" data-command="right">
                            <i class="fa-solid fa-arrow-right w-5"></i> –ü—Ä–∞–≤–æ—Ä—É—á
                        </div>
                        
                        <div id="loopsSection" class="hidden">
                            <div class="w-full mt-2 mb-1 font-bold text-gray-600 text-xs">
                                <i class="fa-solid fa-arrows-spin mr-2"></i>–¶–∏–∫–ª–∏:
                            </div>
                            <div class="block loop haptic-light" draggable="true" data-command="loop">
                                <i class="fa-solid fa-repeat w-5"></i> –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏
                            </div>
                        </div>
                    </div>
                </div>
            
                <!-- –ü—Ä–æ–≥—Ä–∞–º–∞ -->
                <div class="program-container flex flex-col w-full sm:w-[65%]">
                    <div class="blocks-title text-base md:text-lg font-bold mb-3 text-gray-700 flex justify-between">
                        <span><i class="fa-solid fa-wrench mr-2"></i>–ü—Ä–æ–≥—Ä–∞–º–∞</span>
                        <span id="programCount" class="text-xs text-gray-500">0 –±–ª–æ–∫—ñ–≤</span>
                    </div>
                    <!-- –û–ë–õ–ê–°–¢–¨ –î–õ–Ø –ü–ï–†–ï–¢–Ø–ì–£–í–ê–ù–ù–Ø -->
                    <div id="programArea" class="program-area flex-1 bg-gradient-to-br from-gray-100 to-gray-50 p-3 rounded-lg border-2 border-dashed border-gray-400 min-h-[200px] max-h-[400px] overflow-y-auto">
                        <!-- –ë–ª–æ–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–∏ –±—É–¥—É—Ç—å —Ä–µ–Ω–¥–µ—Ä–∏—Ç–∏—Å—å —Ç—É—Ç -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================================
        // –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø
        // ====================================
        const CONFIG = {
            GRID_SIZE: 6,
            MAX_LOOP_COUNT: 5,
            MIN_LOOP_COUNT: 2,
            ANIMATION_DELAY: 350,
            MAX_EXECUTION_STEPS: 500,
            TOTAL_LEVELS: 10,
            TUTORIAL_PHASES: 5, // 0.1 - 0.5
            HAPTIC_ENABLED: 'vibrate' in navigator
        };

        // ====================================
        // –¢–£–¢–û–†–Ü–ê–õ–¨–ù–Ü –†–Ü–í–ù–Ü (PHASES)
        // ====================================
        const TUTORIAL_LEVELS = {
            0.1: {
                name: "üåü –ü–µ—Ä—à–∏–π –∫—Ä–æ–∫",
                // –û–Ω–æ–≤–ª–µ–Ω–æ —Ç–µ–∫—Å—Ç, —â–æ–± –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –∫–ª—ñ–∫ –∞–±–æ D&D
                description: "–ö–ª—ñ–∫–Ω–∏ –∞–±–æ –ø–µ—Ä–µ—Ç—è–≥–Ω–∏ '–ü—Ä–∞–≤–æ—Ä—É—á' —É '–ü—Ä–æ–≥—Ä–∞–º—É'",
                gridSize: 3,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 1, y: 0 },
                startingStrength: 15,
                startingWeapon: 10,
                monsterStrength: 5,
                monsterDefense: 3,
                items: [],
                obstacles: [],
                allowLoops: false,
                forcedCommand: 'right', // –¢—ñ–ª—å–∫–∏ —Ü—è –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
                autoHighlight: true,
                tutorialText: "–ö–ª—ñ–∫–Ω–∏ –∞–±–æ –ø–µ—Ä–µ—Ç—è–≥–Ω–∏ '–ü—Ä–∞–≤–æ—Ä—É—á' —Å—é–¥–∏ ‚Üí",
                optimalSteps: 1
            },
            0.2: {
                name: "‚ÜóÔ∏è –î–≤–∞ –∫—Ä–æ–∫–∏",
                description: "–î–æ–¥–∞–π –∫–æ–º–∞–Ω–¥—É '–ü—Ä–∞–≤–æ—Ä—É—á' –¥–≤–∞ —Ä–∞–∑–∏",
                gridSize: 4,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 2, y: 0 },
                startingStrength: 15,
                startingWeapon: 10,
                monsterStrength: 8,
                monsterDefense: 4,
                items: [],
                obstacles: [],
                allowLoops: false,
                forcedCommand: 'right',
                tutorialText: "–î–æ–¥–∞–π –∫–æ–º–∞–Ω–¥—É —â–µ —Ä–∞–∑! –ö–æ–∂–µ–Ω –∫—Ä–æ–∫ = -1 –°–∏–ª–∞ ‚ö°",
                optimalSteps: 2
            },
            0.3: {
                name: "üí™ –õ—ñ—á–∏–ª—å–Ω–∏–∫ —Å–∏–ª–∏",
                description: "–°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞–π—Ç–µ –∑–∞ —Ç–∏–º, —è–∫ –∑–º—ñ–Ω—é—î—Ç—å—Å—è —Å–∏–ª–∞ –ø—ñ–¥ —á–∞—Å —Ä—É—Ö—É",
                gridSize: 5,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 3, y: 0 },
                startingStrength: 15,
                startingWeapon: 10,
                monsterStrength: 10,
                monsterDefense: 5,
                items: [],
                obstacles: [],
                allowLoops: false,
                tutorialText: "–î–æ–¥–∞–π 3 –∫–æ–º–∞–Ω–¥–∏ '–ü—Ä–∞–≤–æ—Ä—É—á'. –°–ª—ñ–¥–∫—É–π –∑–∞ —Å–∏–ª–æ—é!",
                optimalSteps: 3
            },
            0.4: {
                name: "üå≥ –ü–µ—Ä—à–∞ –ø–µ—Ä–µ—à–∫–æ–¥–∞",
                description: "–û–±—ñ–π–¥–∏ –¥–µ—Ä–µ–≤–æ! –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ä—ñ–∑–Ω—ñ –∫–æ–º–∞–Ω–¥–∏",
                gridSize: 4,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 2, y: 2 },
                startingStrength: 20,
                startingWeapon: 8,
                monsterStrength: 10,
                monsterDefense: 4,
                items: [],
                obstacles: [
                    { x: 1, y: 0, type: 'tree' }
                ],
                allowLoops: false,
                tutorialText: "–î–µ—Ä–µ–≤–æ –±–ª–æ–∫—É—î –ø—Ä—è–º–∏–π —à–ª—è—Ö. –û–±—ñ–π–¥–∏ –π–æ–≥–æ!",
                optimalSteps: 4
            },
            0.5: {
                name: "‚ö° –ó–±—ñ—Ä –±–æ–Ω—É—Å—ñ–≤",
                description: "–ó–±–µ—Ä–∏ —Å–∏–ª—É, —â–æ–± –ø–µ—Ä–µ–º–æ–≥—Ç–∏!",
                gridSize: 5,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 3, y: 0 },
                startingStrength: 10,
                startingWeapon: 8,
                monsterStrength: 12,
                monsterDefense: 5,
                items: [
                    { x: 1, y: 0, type: 'strength', value: 8 }
                ],
                obstacles: [],
                allowLoops: false,
                tutorialText: "‚ö†Ô∏è –ú–∞–ª–æ —Å–∏–ª–∏! –ó–±–µ—Ä–∏ ‚ö° –ø–æ –¥–æ—Ä–æ–∑—ñ –¥–æ –º–æ–Ω—Å—Ç—Ä–∞",
                optimalSteps: 3
            }
        };

        // ====================================
        // –û–°–ù–û–í–ù–Ü –†–Ü–í–ù–Ü (1-10)
        // ====================================
        const MAIN_LEVELS = {
            1: {
                name: "üéØ –í–∏–ø—É—Å–∫–Ω–∏–π —Ä—ñ–≤–µ–Ω—å",
                description: "–¢–µ–ø–µ—Ä —Ç–∏ —Å–∞–º! –î—ñ—Å—Ç–∞–Ω—å—Å—è –¥–æ –º–æ–Ω—Å—Ç—Ä–∞",
                gridSize: 6,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 3, y: 0 },
                startingStrength: 15,
                startingWeapon: 8,
                monsterStrength: 10,
                monsterDefense: 5,
                items: [],
                obstacles: [],
                allowLoops: false,
                hint: "üí° –ü—Ä–æ—Å—Ç–æ –π–¥–∏ –ø—Ä–∞–≤–æ—Ä—É—á 3 —Ä–∞–∑–∏!",
                difficulty: "–õ–µ–≥–∫–æ",
                optimalSteps: 3
            },
            2: {
                name: "‚ÜóÔ∏è –î—ñ–∞–≥–æ–Ω–∞–ª—å",
                description: "–†—É—Ö–∞–π—Å—è –ø–æ –¥—ñ–∞–≥–æ–Ω–∞–ª—ñ",
                gridSize: 6,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 2, y: 2 },
                startingStrength: 15,
                startingWeapon: 5,
                monsterStrength: 10,
                monsterDefense: 4,
                items: [
                    { x: 1, y: 1, type: 'strength', value: 5 }
                ],
                obstacles: [],
                allowLoops: false,
                hint: "üí° –ß–µ—Ä–≥—É–π '–ü—Ä–∞–≤–æ—Ä—É—á' —ñ '–í–Ω–∏–∑'",
                difficulty: "–õ–µ–≥–∫–æ",
                optimalSteps: 4
            },
            3: {
                name: "‚ö° –ó–±—ñ—Ä —Ä–µ—Å—É—Ä—Å—ñ–≤",
                description: "–ó–±–µ—Ä–∏ –í–°–Ü –±–æ–Ω—É—Å–∏!",
                gridSize: 7,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 4, y: 0 },
                startingStrength: 12,
                startingWeapon: 2,
                monsterStrength: 15,
                monsterDefense: 5,
                items: [
                    { x: 1, y: 0, type: 'strength', value: 8 },
                    { x: 2, y: 0, type: 'weapon', value: 4 },
                    { x: 3, y: 0, type: 'strength', value: 5 }
                ],
                obstacles: [],
                allowLoops: false,
                hint: "üí° –ë–µ–∑ —Ä–µ—Å—É—Ä—Å—ñ–≤ –Ω–µ –ø–µ—Ä–µ–º–æ–∂–µ—à!",
                difficulty: "–õ–µ–≥–∫–æ",
                optimalSteps: 4
            },
            4: {
                name: "üó°Ô∏è –û–∑–±—Ä–æ—î–Ω–Ω—è",
                description: "–ó–±–µ—Ä–∏ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∑–±—Ä–æ—ó",
                gridSize: 7,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 3, y: 3 },
                startingStrength: 18,
                startingWeapon: 0,
                monsterStrength: 15,
                monsterDefense: 6,
                items: [
                    { x: 1, y: 1, type: 'weapon', value: 3 },
                    { x: 2, y: 2, type: 'weapon', value: 4 }
                ],
                obstacles: [],
                allowLoops: false,
                hint: "üí° –ó–±—Ä–æ—è >= –ó–∞—Ö–∏—Å—Ç –º–æ–Ω—Å—Ç—Ä–∞!",
                difficulty: "–°–µ—Ä–µ–¥–Ω—å–æ",
                optimalSteps: 6
            },
            5: {
                name: "üå≥ –ü–µ—Ä–µ—à–∫–æ–¥–∏",
                description: "–ó–Ω–∞–π–¥–∏ –æ–±—Ö—ñ–¥!",
                gridSize: 7,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 4, y: 0 },
                startingStrength: 20,
                startingWeapon: 5,
                monsterStrength: 12,
                monsterDefense: 4,
                items: [
                    { x: 2, y: 1, type: 'strength', value: 5 }
                ],
                obstacles: [
                    { x: 2, y: 0, type: 'tree' }
                ],
                allowLoops: false,
                hint: "üí° –û–±—ñ–π–¥–∏ –¥–µ—Ä–µ–≤–æ –∑–≤–µ—Ä—Ö—É –∞–±–æ –∑–Ω–∏–∑—É",
                difficulty: "–°–µ—Ä–µ–¥–Ω—å–æ",
                optimalSteps: 6
            },
            6: {
                name: "ü™® –õ–∞–±—ñ—Ä–∏–Ω—Ç",
                description: "–°–∫–ª–∞–¥–Ω–∏–π —à–ª—è—Ö!",
                gridSize: 8,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 5, y: 3 },
                startingStrength: 25,
                startingWeapon: 2,
                monsterStrength: 18,
                monsterDefense: 5,
                items: [
                    { x: 1, y: 1, type: 'strength', value: 8 },
                    { x: 3, y: 2, type: 'weapon', value: 4 }
                ],
                obstacles: [
                    { x: 1, y: 0, type: 'rock' },
                    { x: 2, y: 1, type: 'tree' },
                    { x: 3, y: 3, type: 'rock' }
                ],
                allowLoops: false,
                hint: "üí° –®—É–∫–∞–π –Ω–∞–π–∫–æ—Ä–æ—Ç—à–∏–π —à–ª—è—Ö",
                difficulty: "–°–µ—Ä–µ–¥–Ω—å–æ",
                optimalSteps: 10
            },
            7: {
                name: "üîÑ –¶–∏–∫–ª–∏ —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ!",
                description: "–û–ø—Ç–∏–º—ñ–∑—É–π –∫–æ–¥ —Ü–∏–∫–ª–∞–º–∏",
                gridSize: 8,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 5, y: 0 },
                startingStrength: 18,
                startingWeapon: 5,
                monsterStrength: 12,
                monsterDefense: 4,
                items: [
                    { x: 2, y: 0, type: 'strength', value: 5 }
                ],
                obstacles: [],
                allowLoops: true,
                hint: "üí° –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π —Ü–∏–∫–ª –∑–∞–º—ñ—Å—Ç—å 5 –∫–æ–º–∞–Ω–¥!",
                difficulty: "–°–µ—Ä–µ–¥–Ω—å–æ",
                optimalSteps: 5
            },
            8: {
                name: "üéØ –ú–∞–π—Å—Ç–µ—Ä —Ü–∏–∫–ª—ñ–≤",
                description: "–ö–æ–º–±—ñ–Ω—É–π —Ü–∏–∫–ª–∏ –∑ –∫–æ–º–∞–Ω–¥–∞–º–∏",
                gridSize: 8,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 4, y: 4 },
                startingStrength: 28,
                startingWeapon: 1,
                monsterStrength: 20,
                monsterDefense: 5,
                items: [
                    { x: 2, y: 2, type: 'strength', value: 8 },
                    { x: 3, y: 3, type: 'weapon', value: 5 }
                ],
                obstacles: [
                    { x: 1, y: 1, type: 'rock' }
                ],
                allowLoops: true,
                hint: "üí° –ö–æ–º–±—ñ–Ω—É–π —Ü–∏–∫–ª–∏ –∑ –∫–æ–º–∞–Ω–¥–∞–º–∏",
                difficulty: "–°–∫–ª–∞–¥–Ω–æ",
                optimalSteps: 8
            },
            9: {
                name: "üèîÔ∏è –í–µ–ª–∏–∫–µ –≤–∏–ø—Ä–æ–±—É–≤–∞–Ω–Ω—è",
                description: "–î–æ–≤–≥–∏–π —à–ª—è—Ö!",
                gridSize: 8,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 6, y: 6 },
                startingStrength: 35,
                startingWeapon: 0,
                monsterStrength: 25,
                monsterDefense: 7,
                items: [
                    { x: 1, y: 2, type: 'strength', value: 10 },
                    { x: 3, y: 3, type: 'weapon', value: 4 },
                    { x: 5, y: 5, type: 'weapon', value: 4 }
                ],
                obstacles: [
                    { x: 1, y: 1, type: 'rock' },
                    { x: 2, y: 3, type: 'tree' },
                    { x: 4, y: 4, type: 'rock' }
                ],
                allowLoops: true,
                hint: "üí° –ó–±–µ—Ä–∏ –í–°–Ü –±–æ–Ω—É—Å–∏ –∑–±—Ä–æ—ó!",
                difficulty: "–°–∫–ª–∞–¥–Ω–æ",
                optimalSteps: 14
            },
            10: {
                name: "üêâ –§—ñ–Ω–∞–ª—å–Ω–∞ –±–∏—Ç–≤–∞",
                description: "–û—Å—Ç–∞–Ω–Ω—ñ–π –≤–∏–∫–ª–∏–∫!",
                gridSize: 8,
                startPos: { x: 0, y: 0 },
                finishPos: { x: 7, y: 7 },
                startingStrength: 40,
                startingWeapon: 0,
                monsterStrength: 28,
                monsterDefense: 8,
                items: [
                    { x: 1, y: 1, type: 'weapon', value: 3 },
                    { x: 2, y: 3, type: 'strength', value: 12 },
                    { x: 4, y: 2, type: 'weapon', value: 3 },
                    { x: 5, y: 5, type: 'strength', value: 10 },
                    { x: 6, y: 6, type: 'weapon', value: 3 }
                ],
                obstacles: [
                    { x: 1, y: 0, type: 'rock' },
                    { x: 2, y: 2, type: 'tree' },
                    { x: 3, y: 4, type: 'rock' },
                    { x: 6, y: 5, type: 'rock' }
                ],
                allowLoops: true,
                hint: "üí° –¶–µ —Ñ—ñ–Ω–∞–ª! –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π –≤—Å—ñ –∑–Ω–∞–Ω–Ω—è!",
                difficulty: "–î—É–∂–µ —Å–∫–ª–∞–¥–Ω–æ",
                optimalSteps: 16
            }
        };

        // –û–±'—î–¥–Ω–∞—Ç–∏ –≤—Å—ñ —Ä—ñ–≤–Ω—ñ
        const LEVELS = { ...TUTORIAL_LEVELS, ...MAIN_LEVELS };

        // ====================================
        // –°–¢–ê–ù –ì–†–ò
        // ====================================
        const GameState = {
            currentLevel: 0.1,
            currentPhase: 1, // –î–ª—è tracking tutorial phases
            heroPos: { x: 0, y: 0 },
            startPos: { x: 0, y: 0 },
            finishPos: { x: 1, y: 0 },
            items: [],
            obstacles: [],
            collectedItems: new Set(),
            currentStrength: 15,
            currentWeapon: 10,
            monsterStrength: 5,
            monsterDefense: 3,
            program: [],
            isRunning: false,
            executionStepCount: 0,
            completedLevels: new Set(),
            storyShown: localStorage.getItem('storyShown') === 'true',
            isTutorialMode: true,

            loadLevel(levelNum) {
                const level = LEVELS[levelNum];
                if (!level) return;

                this.currentLevel = levelNum;
                this.isTutorialMode = levelNum < 1;
                CONFIG.GRID_SIZE = level.gridSize;
                this.startPos = { ...level.startPos };
                this.finishPos = { ...level.finishPos };
                this.items = level.items.map(item => ({ ...item }));
                this.obstacles = level.obstacles ? level.obstacles.map(obs => ({ ...obs })) : [];
                this.currentStrength = level.startingStrength;
                this.currentWeapon = level.startingWeapon;
                this.monsterStrength = level.monsterStrength;
                this.monsterDefense = level.monsterDefense;
                
                // –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ —Ü–∏–∫–ª–∏
                document.getElementById('loopsSection').classList.toggle('hidden', !level.allowLoops);
                
                // Forced tutorial mode
                if (level.forcedCommand) {
                    this.applyForcedMode(level.forcedCommand);
                } else {
                    this.removeForcedMode();
                }
                
                // Highlight –¥–ª—è tutorial
                if (level.autoHighlight) {
                    this.highlightTutorialElements(level.forcedCommand);
                }
                
                this.updateLevelUI(level);
                this.reset(true);
            },

            applyForcedMode(command) {
                document.querySelectorAll('.block[data-command]').forEach(block => {
                    if (block.dataset.command !== command) {
                        block.classList.add('tutorial-dimmed');
                    } else {
                        block.classList.remove('tutorial-dimmed');
                    }
                });
            },

            removeForcedMode() {
                document.querySelectorAll('.block[data-command]').forEach(block => {
                    block.classList.remove('tutorial-dimmed', 'tutorial-highlight');
                });
            },

            highlightTutorialElements(command) {
                setTimeout(() => {
                    document.querySelectorAll('.block[data-command]').forEach(block => {
                        if (block.dataset.command === command) {
                            block.classList.add('tutorial-highlight');
                        }
                    });
                    // –¢–∞–∫–æ–∂ –ø—ñ–¥—Å–≤—ñ—á—É—î–º–æ –∑–æ–Ω—É –ø—Ä–æ–≥—Ä–∞–º–∏
                    document.getElementById('programArea').classList.add('tutorial-highlight');
                }, 500);
            },

            updateLevelUI(level) {
                const levelInfo = document.getElementById('levelInfo');
                levelInfo.innerHTML = `
                    <div class="font-bold text-base mb-1">${level.name}</div>
                    <div class="text-sm mb-2">${level.description}</div>
                    ${level.tutorialText ? `<div class="text-xs italic text-indigo-600 mb-2">${level.tutorialText}</div>` : ''}
                    ${level.hint && !this.isTutorialMode ? `<div class="text-xs italic mb-2">${level.hint}</div>` : ''}
                    <div class="flex flex-wrap gap-2 text-xs">
                        <span class="bg-red-100 text-red-700 px-2 py-1 rounded">üí™ –ú–æ–Ω—Å—Ç—Ä: ${this.monsterStrength}</span>
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded">üõ°Ô∏è –ó–∞—Ö–∏—Å—Ç: ${this.monsterDefense}</span>
                        ${level.difficulty ? `<span class="bg-purple-100 text-purple-700 px-2 py-1 rounded">üìä ${level.difficulty}</span>` : ''}
                        ${level.optimalSteps ? `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded">üéØ –û–ø—Ç–∏–º—É–º: ${level.optimalSteps} –∫—Ä–æ–∫—ñ–≤</span>` : ''}
                    </div>
                `;
                
                // –ó–Ω—è—Ç–∏ –ø—ñ–¥—Å–≤—ñ—Ç–∫—É –∑ –∑–æ–Ω–∏ –ø—Ä–æ–≥—Ä–∞–º–∏, —è–∫—â–æ –≤–æ–Ω–∞ –±—É–ª–∞
                if (this.currentLevel > 0.1) {
                    document.getElementById('programArea').classList.remove('tutorial-highlight');
                }

                // –ü—Ä–æ–≥—Ä–µ—Å
                const totalLevels = CONFIG.TUTORIAL_PHASES + CONFIG.TOTAL_LEVELS;
                const currentProgress = this.isTutorialMode ? 
                    (this.currentLevel * 10) / totalLevels * 100 : 
                    ((CONFIG.TUTORIAL_PHASES + this.currentLevel) / totalLevels) * 100;
                document.getElementById('levelProgressBar').style.width = `${currentProgress}%`;
                
                // –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
                document.getElementById('prevLevel').disabled = this.currentLevel === 0.1;
                const maxLevel = Math.max(0, ...[...this.completedLevels].filter(l => l >= 1));
                const canGoNext = this.isTutorialMode ? 
                    (this.currentLevel + 0.1 <= 0.5) : // –ó–∞–≤–∂–¥–∏ –º–æ–∂–Ω–∞ –π—Ç–∏ –¥–∞–ª—ñ –≤ —Ç—É—Ç–æ—Ä—ñ–∞–ª—ñ
                    this.currentLevel < CONFIG.TOTAL_LEVELS && this.completedLevels.has(this.currentLevel);
                
                // –î–æ–∑–≤–æ–ª–∏—Ç–∏ –ø–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä—ñ–≤–µ–Ω—å, —è–∫—â–æ –ø–æ—Ç–æ—á–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ
                let nextLevelNum = this.isTutorialMode ? 1 : this.currentLevel + 1;
                if (this.isTutorialMode && this.currentLevel === 0.5) nextLevelNum = 1;
                
                const nextLevelAvailable = this.completedLevels.has(this.currentLevel) || 
                                           (this.isTutorialMode && this.currentLevel < 0.5) ||
                                           (maxLevel > 0 && this.currentLevel <= maxLevel); // –î–æ–∑–≤–æ–ª–∏—Ç–∏ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏—Å—å

                document.getElementById('nextLevel').disabled = this.currentLevel === CONFIG.TOTAL_LEVELS || !nextLevelAvailable;
            },

            reset(resetRunning = true) {
                this.heroPos = { ...this.startPos };
                this.collectedItems.clear();
                const level = LEVELS[this.currentLevel];
                this.currentStrength = level.startingStrength;
                this.currentWeapon = level.startingWeapon;
                this.executionStepCount = 0;
                if (resetRunning) this.isRunning = false;
            },

            isObstacle(x, y) {
                return this.obstacles.some(obs => obs.x === x && obs.y === y);
            }
        };

        // ====================================
        // HAPTIC FEEDBACK
        // ====================================
        const HapticFeedback = {
            light() {
                if (CONFIG.HAPTIC_ENABLED) navigator.vibrate(10);
            },
            medium() {
                if (CONFIG.HAPTIC_ENABLED) navigator.vibrate(20);
            },
            success() {
                if (CONFIG.HAPTIC_ENABLED) navigator.vibrate([30, 50, 30]);
            },
            error() {
                if (CONFIG.HAPTIC_ENABLED) navigator.vibrate([50, 100, 50]);
            }
        };

        // ====================================
        // DND –°–¢–ê–ù
        // ====================================
        const DragState = {
            draggedItemData: null,
            dragPlaceholder: null,
            touchClone: null,
            currentTouchId: null,
            isDragging: false,
            // –î–û–î–ê–ù–û: –°—Ç–∞–Ω–∏ –¥–ª—è —Ä–æ–∑—Ä—ñ–∑–Ω–µ–Ω–Ω—è click/tap —Ç–∞ drag
            dragTargetElement: null,
            dragStartTime: 0,
            dragStartPos: null,
            isDragPending: false,

            init() {
                this.dragPlaceholder = document.createElement('div');
                this.dragPlaceholder.className = 'drag-placeholder';
            },

            moveTouchClone(touch) {
                if (this.touchClone) {
                    this.touchClone.style.left = `${touch.clientX - this.touchClone.offsetWidth / 2}px`;
                    this.touchClone.style.top = `${touch.clientY - this.touchClone.offsetHeight / 2}px`;
                }
            },

            cleanup() {
                if (this.touchClone) {
                    this.touchClone.remove();
                    this.touchClone = null;
                }
                // currentTouchId –æ—á–∏—â—É—î—Ç—å—Å—è –≤ touchend
                this.isDragging = false;
                this.draggedItemData = null;
                document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
                this.dragPlaceholder?.remove();
                
                // –î–û–î–ê–ù–û: –û—á–∏—â–µ–Ω–Ω—è —Å—Ç–∞–Ω—ñ–≤ tap/drag
                this.isDragPending = false;
                this.dragTargetElement = null;
                this.dragStartPos = null;
            }
        };

        // ====================================
        // DOM
        // ====================================
        const DOM = {
            grid: null,
            programArea: null,
            position: null,
            strength: null,
            weapon: null,
            modal: null,
            modalContent: null,
            modalIcon: null,
            modalTitle: null,
            modalMessage: null,
            modalButtons: null,
            currentLevelSpan: null,
            stepCounter: null,
            stepCount: null,
            programCount: null,

            cache() {
                this.grid = document.querySelector('.grid');
                this.programArea = document.getElementById('programArea');
                this.weapon = document.getElementById('weapon');
                this.position = document.getElementById('position');
                this.strength = document.getElementById('strength');
                this.modal = document.getElementById('modal');
                this.modalContent = document.getElementById('modalContent');
                this.modalIcon = document.getElementById('modalIcon');
                this.modalTitle = document.getElementById('modalTitle');
                this.modalMessage = document.getElementById('modalMessage');
                this.modalButtons = document.getElementById('modalButtons');
                this.currentLevelSpan = document.getElementById('currentLevel');
                this.stepCounter = document.getElementById('stepCounter');
                this.stepCount = document.getElementById('stepCount');
                this.programCount = document.getElementById('programCount');
            }
        };

        // ====================================
        // –£–¢–ò–õ–Ü–¢–ò
        // ====================================
        const Utils = {
            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },

            calculateTotalSteps(programArray, maxDepth = 3) {
                const calculate = (items, depth = 0) => {
                    if (depth > maxDepth) return CONFIG.MAX_EXECUTION_STEPS;
                    let total = 0;
                    for (const item of items) {
                        if (item.type === 'loop') {
                            const loopBodyCost = calculate(item.commands, depth + 1);
                            if (loopBodyCost >= CONFIG.MAX_EXECUTION_STEPS) {
                                return CONFIG.MAX_EXECUTION_STEPS;
                            }
                            total += item.count * loopBodyCost;
                        } else {
                            total += 1;
                        }
                        if (total >= CONFIG.MAX_EXECUTION_STEPS) {
                             return CONFIG.MAX_EXECUTION_STEPS;
                        }
                    }
                    return total;
                };
                return calculate(programArray);
            }
        };

        // ====================================
        // –†–ï–ù–î–ï–†–ò–ù–ì –°–Ü–¢–ö–ò
        // ====================================
        const GridRenderer = {
            render() {
                DOM.grid.innerHTML = '';
                const size = CONFIG.GRID_SIZE;
                DOM.grid.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
                DOM.grid.style.gridTemplateRows = `repeat(${size}, 1fr)`;

                for (let y = 0; y < size; y++) {
                    for (let x = 0; x < size; x++) {
                        const cell = this.createCell(x, y);
                        DOM.grid.appendChild(cell);
                    }
                }
                this.updateStats();
            },

            createCell(x, y) {
                const cell = document.createElement('div');
                cell.className = 'cell w-full h-full bg-gray-100 flex items-center justify-center transition-colors';
                cell.dataset.x = x;
                cell.dataset.y = y;

                const itemKey = `${x},${y}`;

                if (x === GameState.heroPos.x && y === GameState.heroPos.y) {
                    cell.classList.add('bg-blue-200');
                    cell.innerHTML = '<i class="fa-solid fa-user-shield text-blue-700"></i>';
                    return cell;
                }

                if (x === GameState.finishPos.x && y === GameState.finishPos.y) {
                    cell.classList.add('bg-red-300');
                    if (GameState.isRunning) cell.classList.add('pulse-hint');
                    cell.innerHTML = '<i class="fa-solid fa-dragon text-red-700"></i>';
                    return cell;
                }

                if (GameState.isObstacle(x, y)) {
                    const obstacle = GameState.obstacles.find(obs => obs.x === x && obs.y === y);
                    if (obstacle.type === 'tree') {
                        cell.classList.add('bg-green-600');
                        cell.innerHTML = '<i class="fa-solid fa-tree text-green-900"></i>';
                    } else if (obstacle.type === 'rock') {
                        cell.classList.add('bg-gray-400');
                        cell.innerHTML = '<i class="fa-solid fa-mountain text-gray-700"></i>';
                    }
                    return cell;
                }

                if (!GameState.collectedItems.has(itemKey)) {
                    const foundItem = GameState.items.find(item => item.x === x && item.y === y);
                    if (foundItem) {
                        if (foundItem.type === 'strength') {
                            cell.classList.add('bg-yellow-200');
                            cell.innerHTML = `<i class="fa-solid fa-bolt text-yellow-600"></i>`;
                        } else if (foundItem.type === 'weapon') {
                            cell.classList.add('bg-gray-300');
                            cell.innerHTML = `<i class="fa-solid fa-gavel text-gray-700"></i>`;
                        }
                    }
                }

                return cell;
            },

            updateStats() {
                DOM.weapon.textContent = GameState.currentWeapon;
                DOM.position.textContent = `(${GameState.heroPos.x},${GameState.heroPos.y})`;
                DOM.strength.textContent = GameState.currentStrength;
                DOM.currentLevelSpan.textContent = GameState.currentLevel;
                
                const totalSteps = Utils.calculateTotalSteps(GameState.program);
                DOM.stepCount.textContent = totalSteps;
                
                if (totalSteps > 0) {
                    DOM.stepCounter.classList.remove('hidden');
                } else {
                    DOM.stepCounter.classList.add('hidden');
                }
            }
        };

        // ====================================
        // –í–ò–ö–û–ù–ê–ù–ù–Ø –ü–†–û–ì–†–ê–ú–ò
        // ====================================
        const ProgramExecutor = {
            async run() {
                if (GameState.isRunning) return;

                if (GameState.program.length === 0) {
                    ModalManager.show('ü§î –ü—Ä–æ–≥—Ä–∞–º–∞ –ø–æ—Ä–æ–∂–Ω—è', '–î–æ–¥–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥–∏!', 'error');
                    HapticFeedback.error();
                    return;
                }

                const estimatedSteps = Utils.calculateTotalSteps(GameState.program);
                if (estimatedSteps >= CONFIG.MAX_EXECUTION_STEPS) {
                    ModalManager.show('‚ö†Ô∏è –ó–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–æ', `–ü—Ä–æ–≥—Ä–∞–º–∞ –≤–∏–∫–æ–Ω–∞—î—Ç—å—Å—è –∑–∞ ${estimatedSteps} –∫—Ä–æ–∫—ñ–≤.\n\n–ú–∞–∫—Å–∏–º—É–º: ${CONFIG.MAX_EXECUTION_STEPS}`, 'error');
                    HapticFeedback.error();
                    return;
                }

                GameState.isRunning = true;
                ModalManager.hide();
                GameState.reset(false);
                GridRenderer.render();
                HapticFeedback.medium();
                
                // –î–û–î–ê–ù–û: –ê–≤—Ç–æ-—Å–∫—Ä–æ–ª –¥–æ —ñ–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
                const gridContainer = document.querySelector('.grid-container');
                if (gridContainer) {
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ 'start' –∞–±–æ 'nearest' –¥–ª—è –∫—Ä–∞—â–æ—ó –≤–∏–¥–∏–º–æ—Å—Ç—ñ
                    gridContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                try {
                    await this.execute(GameState.program);
                } catch (error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:', error);
                    ModalManager.show('‚ùå –ü–æ–º–∏–ª–∫–∞', '–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è', 'error');
                    HapticFeedback.error();
                } finally {
                    const wasRunning = GameState.isRunning;
                    GameState.isRunning = false;
                    this.checkWin(true, wasRunning);
                }
            },

            async execute(commandList) {
                for (const item of commandList) {
                    if (!GameState.isRunning) return;

                    GameState.executionStepCount++;
                    if (GameState.executionStepCount > CONFIG.MAX_EXECUTION_STEPS) {
                        ModalManager.show('‚è±Ô∏è –¢–∞–π–º-–∞—É—Ç', '–ü—Ä–æ–≥—Ä–∞–º–∞ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–æ', 'error');
                        HapticFeedback.error();
                        GameState.isRunning = false;
                        return;
                    }

                    if (item.type === 'loop') {
                        for (let i = 0; i < item.count; i++) {
                            if (!GameState.isRunning) return;
                            await this.execute(item.commands);
                        }
                    } else {
                        if (GameState.currentStrength <= 0) {
                            ModalManager.show('üíÄ –ù–µ–º–∞—î —Å–∏–ª–∏', '–ó–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è —Å–∏–ª–∞!\n\n–ó–±–∏—Ä–∞–π—Ç–µ –±–æ–Ω—É—Å–∏.', 'error');
                            HapticFeedback.error();
                            GameState.isRunning = false;
                            return;
                        }

                        await Utils.sleep(CONFIG.ANIMATION_DELAY);
                        this.executeCommand(item.command);
                        GridRenderer.render();
                        HapticFeedback.light();
                    }
                    
                    if (this.checkWin()) return;
                }
            },

            executeCommand(command) {
                const newPos = { ...GameState.heroPos };

                switch (command) {
                    case 'up': newPos.y = Math.max(0, GameState.heroPos.y - 1); break;
                    case 'down': newPos.y = Math.min(CONFIG.GRID_SIZE - 1, GameState.heroPos.y + 1); break;
                    case 'left': newPos.x = Math.max(0, GameState.heroPos.x - 1); break;
                    case 'right': newPos.x = Math.min(CONFIG.GRID_SIZE - 1, GameState.heroPos.x + 1); break;
                }

                if (GameState.isObstacle(newPos.x, newPos.y)) return;

                GameState.heroPos = newPos;
                GameState.currentStrength--;

                const itemKey = `${GameState.heroPos.x},${GameState.heroPos.y}`;
                if (!GameState.collectedItems.has(itemKey)) {
                    const foundItem = GameState.items.find(item => 
                        item.x === GameState.heroPos.x && item.y === GameState.heroPos.y
                    );
                    if (foundItem) {
                        if (foundItem.type === 'strength') {
                            GameState.currentStrength += foundItem.value;
                        } else if (foundItem.type === 'weapon') {
                            GameState.currentWeapon += foundItem.value;
                        }
                        GameState.collectedItems.add(itemKey);
                        HapticFeedback.medium();
                    }
                }
            },

            checkWin(isFinalCheck = false, wasRunning = true) {
                if (GameState.heroPos.x === GameState.finishPos.x && 
                    GameState.heroPos.y === GameState.finishPos.y) {
                    
                    const hasEnoughStrength = GameState.currentStrength > GameState.monsterStrength;
                    const hasEnoughWeapon = GameState.currentWeapon >= GameState.monsterDefense;

                    if (hasEnoughStrength && hasEnoughWeapon) {
                        GameState.completedLevels.add(GameState.currentLevel);
                        HapticFeedback.success();
                        
                        const level = LEVELS[GameState.currentLevel];
                        const totalSteps = Utils.calculateTotalSteps(GameState.program);
                        let stars = '‚≠ê';
                        if (level.optimalSteps) {
                            if (totalSteps === level.optimalSteps) stars = '‚≠ê‚≠ê‚≠ê';
                            else if (totalSteps <= level.optimalSteps + 2) stars = '‚≠ê‚≠ê';
                        }
                        
                        GameState.updateLevelUI(level);

                        if (GameState.isTutorialMode) {
                            const nextPhase = GameState.currentLevel + 0.1;
                            if (nextPhase <= 0.5) {
                                ModalManager.show(
                                    `üéâ –ß—É–¥–æ–≤–æ! ${stars}`,
                                    `–í–∏ –ø—Ä–æ–π—à–ª–∏ —Ñ–∞–∑—É ${GameState.currentLevel}!\n\n–ö—Ä–æ–∫—ñ–≤: ${totalSteps}\n\n–î–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —Ñ–∞–∑–∏!`,
                                    'success',
                                    [
                                        {
                                            text: '‚ñ∂Ô∏è –î–∞–ª—ñ',
                                            class: 'bg-green-500 hover:bg-green-600',
                                            action: () => {
                                                LevelManager.loadNext();
                                                ModalManager.hide();
                                            }
                                        }
                                    ]
                                );
                            } else {
                                GameState.completedLevels.add(0.5); 
                                GameState.updateLevelUI(level);
                                ModalManager.show(
                                    'üéì –¢—É—Ç–æ—Ä—ñ–∞–ª –ø—Ä–æ–π–¥–µ–Ω–æ!',
                                    '–í—ñ—Ç–∞—î–º–æ! –¢–µ–ø–µ—Ä –≤–∏ –≥–æ—Ç–æ–≤—ñ –¥–æ —Å–ø—Ä–∞–≤–∂–Ω—ñ—Ö —Ä—ñ–≤–Ω—ñ–≤!\n\n–ü–æ—á–∏–Ω–∞—î–º–æ –†—ñ–≤–µ–Ω—å 1!',
                                    'success',
                                    [
                                        {
                                            text: 'üöÄ –î–æ —Ä—ñ–≤–Ω—è 1!',
                                            class: 'bg-indigo-500 hover:bg-indigo-600',
                                            action: () => {
                                                LevelManager.loadNext(); 
                                                ModalManager.hide();
                                            }
                                        }
                                    ]
                                );
                            }
                        } else {
                            if (GameState.currentLevel < CONFIG.TOTAL_LEVELS) {
                                ModalManager.show(
                                    `üéâ –ü–µ—Ä–µ–º–æ–≥–∞! ${stars}`,
                                    `–†—ñ–≤–µ–Ω—å ${GameState.currentLevel} –ø—Ä–æ–π–¥–µ–Ω–æ!\n\n–ö—Ä–æ–∫—ñ–≤: ${totalSteps}${level.optimalSteps ? `\n–û–ø—Ç–∏–º—É–º: ${level.optimalSteps}` : ''}`,
                                    'success',
                                    [
                                        {
                                            text: '‚ñ∂Ô∏è –î–∞–ª—ñ',
                                            class: 'bg-green-500 hover:bg-green-600',
                                            action: () => {
                                                LevelManager.loadNext();
                                                ModalManager.hide();
                                            }
                                        },
                                        {
                                            text: 'üîÑ –ü–æ–∫—Ä–∞—â–∏—Ç–∏',
                                            class: 'bg-blue-500 hover:bg-blue-600',
                                            action: () => {
                                                GameState.loadLevel(GameState.currentLevel);
                                                GridRenderer.render();
                                                ModalManager.hide();
                                            }
                                        }
                                    ]
                                );
                            } else {
                                ModalManager.show(
                                    'üèÜ –í–°–ï –ü–†–û–ô–î–ï–ù–û!',
                                    '–í—ñ—Ç–∞—î–º–æ! –í–∏ –ø—Ä–æ–π—à–ª–∏ –≤—Å—ñ —Ä—ñ–≤–Ω—ñ!\n\n–í–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –º–∞–π—Å—Ç–µ—Ä –∞–ª–≥–æ—Ä–∏—Ç–º—ñ–≤! üéä',
                                    'success'
                                );
                            }
                        }
                    } else {
                        let errorMsg = '‚öîÔ∏è –ü—Ä–æ–≥—Ä–∞–ª–∏ –±—ñ–π!\n\n';
                        if (!hasEnoughStrength) {
                            errorMsg += `üíî –°–∏–ª–∞: ${GameState.currentStrength} (—Ç—Ä–µ–±–∞ > ${GameState.monsterStrength})\n`;
                        }
                        if (!hasEnoughWeapon) {
                            errorMsg += `üó°Ô∏è –ó–±—Ä–æ—è: ${GameState.currentWeapon} (—Ç—Ä–µ–±–∞ >= ${GameState.monsterDefense})`;
                        }
                        errorMsg += '\n\n–ó–±–µ—Ä—ñ—Ç—å –±—ñ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å—ñ–≤!';
                        
                        ModalManager.show('üò¢ –ü–æ—Ä–∞–∑–∫–∞', errorMsg, 'error');
                        HapticFeedback.error();
                    }
                    GameState.isRunning = false;
                    return true;
                } else if (isFinalCheck && wasRunning) {
                    ModalManager.show('ü§î –•–º...', '–í–∏ –Ω–µ –¥—ñ—Å—Ç–∞–ª–∏—Å—è –º–æ–Ω—Å—Ç—Ä–∞!\n\n–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∞–ª–≥–æ—Ä–∏—Ç–º.', 'error');
                    HapticFeedback.error();
                    return false;
                }
                return false;
            }
        };

        // ====================================
        // –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û
        // ====================================
        const ModalManager = {
            show(title, text, type, buttons = null) {
                if (!DOM.modal.classList.contains('hidden') && !GameState.isRunning) return;

                DOM.modalTitle.textContent = title;
                DOM.modalMessage.textContent = text;

                DOM.modalIcon.innerHTML = '';
                DOM.modalIcon.className = 'w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl';

                if (type === 'success') {
                    DOM.modalIcon.classList.add('bg-green-100', 'text-green-600', 'level-complete');
                    DOM.modalIcon.innerHTML = '<i class="fa-solid fa-check"></i>';
                } else {
                    DOM.modalIcon.classList.add('bg-red-100', 'text-red-600');
                    DOM.modalIcon.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                }

                DOM.modalButtons.innerHTML = '';
                if (buttons && Array.isArray(buttons)) {
                    buttons.forEach(btn => {
                        const button = document.createElement('button');
                        button.textContent = btn.text;
                        button.className = `haptic-light py-3 px-6 font-semibold rounded-lg shadow-md transition-all text-white ${btn.class}`;
                        button.addEventListener('click', () => {
                            HapticFeedback.light();
                            btn.action();
                        });
                        DOM.modalButtons.appendChild(button);
                    });
                } else {
                    const defaultBtn = document.createElement('button');
                    defaultBtn.textContent = '–ó—Ä–æ–∑—É–º—ñ–ª–æ';
                    defaultBtn.className = `haptic-light py-3 px-8 font-semibold rounded-lg shadow-md transition-all text-white ${
                        type === 'success' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'
                    }`;
                    defaultBtn.addEventListener('click', () => {
                        HapticFeedback.light();
                        ModalManager.hide();
                    });
                    DOM.modalButtons.appendChild(defaultBtn);
                }

                DOM.modal.classList.remove('hidden');

                requestAnimationFrame(() => {
                    DOM.modalContent.classList.remove('scale-95', 'opacity-0');
                    DOM.modalContent.classList.add('scale-100', 'opacity-100');
                });
            },

            hide() {
                DOM.modalContent.classList.add('scale-95', 'opacity-0');
                DOM.modalContent.classList.remove('scale-100', 'opacity-100');

                setTimeout(() => {
                    DOM.modal.classList.add('hidden');
                }, 200);
            }
        };

        // ====================================
        // –ú–ï–ù–ï–î–ñ–ï–† –†–Ü–í–ù–Ü–í
        // ====================================
        const LevelManager = {
            loadNext() {
                let nextLevel;
                if (GameState.isTutorialMode) {
                    nextLevel = Math.round((GameState.currentLevel + 0.1) * 10) / 10;
                    if (nextLevel > 0.5) nextLevel = 1;
                } else {
                    nextLevel = GameState.currentLevel + 1;
                }

                if (nextLevel <= CONFIG.TOTAL_LEVELS || (nextLevel > 0.5 && nextLevel <= 1)) {
                    GameState.program = [];
                    GameState.loadLevel(nextLevel);
                    GridRenderer.render();
                    ProgramRenderer.render();
                    HapticFeedback.medium();
                }
            },

            loadPrev() {
                let prevLevel;
                if (GameState.currentLevel === 1) {
                    prevLevel = 0.5;
                } else if (GameState.isTutorialMode) {
                    prevLevel = Math.round((GameState.currentLevel - 0.1) * 10) / 10;
                    if (prevLevel < 0.1) prevLevel = 0.1;
                } else {
                    prevLevel = GameState.currentLevel - 1;
                }

                if (prevLevel < 0.1) prevLevel = 0.1;

                GameState.program = [];
                GameState.loadLevel(prevLevel);
                GridRenderer.render();
                ProgramRenderer.render();
                HapticFeedback.medium();
            }
        };

        // ====================================
        // –†–ï–ù–î–ï–†–ò–ù–ì –ü–†–û–ì–†–ê–ú–ò
        // ====================================
        const ProgramRenderer = {
            render() {
                DOM.programArea.innerHTML = '';
                this.renderContainer(DOM.programArea, GameState.program, '');
                
                const blockCount = GameState.program.length;
                DOM.programCount.textContent = `${blockCount} –±–ª–æ–∫—ñ–≤`;
                
                GridRenderer.updateStats();
            },

            renderContainer(container, items, pathPrefix) {
                if (items.length === 0 && container !== DOM.programArea) {
                    container.innerHTML = '<div class="text-center text-xs text-white/70 p-2">–ü–µ—Ä–µ—Ç—è–≥–Ω–∏ –∫–æ–º–∞–Ω–¥–∏ —Å—é–¥–∏</div>';
                }

                items.forEach((item, index) => {
                    const currentPath = pathPrefix ? `${pathPrefix},${index}` : `${index}`;
                    const blockEl = this.createBlock(item, currentPath);
                    blockEl.classList.add('fade-in');
                    container.appendChild(blockEl);
                });
            },

            createBlock(item, path) {
                const blockEl = document.createElement('div');
                blockEl.dataset.path = path;
                blockEl.setAttribute('draggable', 'true');
                blockEl.className = 'program-block p-2 md:p-3 shadow-md transition-transform duration-150 mb-2 rounded-lg';

                const commandIcons = {
                    'up': 'fa-arrow-up',
                    'down': 'fa-arrow-down',
                    'left': 'fa-arrow-left',
                    'right': 'fa-arrow-right'
                };
                const commandText = {
                    'up': '–í–≥–æ—Ä—É',
                    'down': '–í–Ω–∏–∑',
                    'left': '–õ—ñ–≤–æ—Ä—É—á',
                    'right': '–ü—Ä–∞–≤–æ—Ä—É—á'
                };

                if (item.type === 'loop') {
                    this.setupLoopBlock(blockEl, item, path);
                } else {
                    this.setupCommandBlock(blockEl, item, path, commandIcons, commandText);
                }

                // –û–±—Ä–æ–±–Ω–∏–∫–∏ D&D –¥–ª—è —ñ—Å–Ω—É—é—á–∏—Ö –±–ª–æ–∫—ñ–≤ (–ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è)
                blockEl.addEventListener('dragstart', (e) => {
                    if (GameState.isRunning) {
                        e.preventDefault();
                        return;
                    }
                    e.stopPropagation(); 
                    HapticFeedback.light();
                    
                    DragState.draggedItemData = {
                        path: e.target.dataset.path,
                        isNew: false
                    };
                    
                    setTimeout(() => {
                        e.target.classList.add('dragging');
                    }, 0);
                    DragState.isDragging = true;
                });

                blockEl.addEventListener('dragend', (e) => {
                    e.stopPropagation();
                    e.target.classList.remove('dragging');
                    DragState.cleanup();
                });
                
                // –ó–ú–Ü–ù–ï–ù–û: –û–±—Ä–æ–±–Ω–∏–∫ Touch D&D (–≤—ñ–¥—Ä—ñ–∑–Ω—è—î tap/drag)
                blockEl.addEventListener('touchstart', (e) => {
                    // –Ü–≥–Ω–æ—Ä—É–≤–∞—Ç–∏, —è–∫—â–æ –∫–ª—ñ–∫ –Ω–∞ –∫–Ω–æ–ø—Ü—ñ –∞–±–æ —ñ–Ω–ø—É—Ç—ñ
                    if (e.target.closest('button, input')) return;
                    if (GameState.isRunning || DragState.isDragging) return;

                    const touch = e.changedTouches[0];
                    DragState.currentTouchId = touch.identifier;
                    DragState.dragTargetElement = e.target; 
                    DragState.dragStartTime = Date.now();
                    DragState.dragStartPos = { x: touch.clientX, y: touch.clientY };
                    DragState.isDragPending = true; // –ß–µ–∫–∞—î–º–æ –Ω–∞ 'touchmove'
                }, { passive: true }); // –î–æ–∑–≤–æ–ª—è—î–º–æ —Å–∫—Ä–æ–ª, –ø–æ–∫–∏ –Ω–µ –ø–æ—á–∞–≤—Å—è D&D

                return blockEl;
            },

            setupLoopBlock(blockEl, item, path) {
                blockEl.classList.add('bg-pink-500', 'text-white', 'p-3');
                blockEl.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold flex items-center text-xs md:text-sm">
                            <i class="fa-solid fa-repeat mr-2"></i>
                            –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ 
                            <input type="number" class="loop-count w-12 text-center bg-white text-pink-500 font-bold rounded mx-2 p-1" value="${item.count}" min="${CONFIG.MIN_LOOP_COUNT}" max="${CONFIG.MAX_LOOP_COUNT}">
                            —Ä–∞–∑—ñ–≤
                        </span>
                        <button class="remove-btn haptic-light w-7 h-7 bg-white/20 hover:bg-white/40 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-xmark text-white"></i>
                        </button>
                    </div>
                    <div class="loop-body bg-black/10 p-2 rounded-lg min-h-[50px] border-2 border-dashed border-white/30" data-path="${path}"></div>
                `;

                const loopBody = blockEl.querySelector('.loop-body');
                this.renderContainer(loopBody, item.commands, path);

                blockEl.querySelector('.loop-count').addEventListener('change', (e) => {
                    ProgramDataManager.updateLoopCount(path, e.target.value);
                });

                blockEl.querySelector('.remove-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    ProgramDataManager.removeItemByPath(path);
                    this.render();
                    HapticFeedback.light();
                });
            },

            setupCommandBlock(blockEl, item, path, commandIcons, commandText) {
                blockEl.classList.add('bg-indigo-500', 'text-white', 'flex', 'justify-between', 'items-center', 'cursor-move');
                blockEl.innerHTML = `
                    <span class="font-semibold flex items-center text-xs md:text-sm">
                        <i class="fa-solid ${commandIcons[item.command]} mr-2 w-5"></i>
                        ${commandText[item.command]}
                    </span>
                    <button class="remove-btn haptic-light w-7 h-7 bg-white/20 hover:bg-white/40 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-xmark text-white"></i>
                    </button>
                `;

                blockEl.querySelector('.remove-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    ProgramDataManager.removeItemByPath(path);
                    this.render();
                    HapticFeedback.light();
                });
            }
        };

        // ====================================
        // –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –î–ê–ù–ò–ú–ò
        // ====================================
        const ProgramDataManager = {
            findDropTarget(pathStr) {
                if (!pathStr) return GameState.program;

                const path = pathStr.split(',').map(Number);
                let target = GameState.program;

                for (const index of path) {
                    if (target[index] && target[index].commands) {
                        target = target[index].commands;
                    } else {
                        return null; 
                    }
                }
                return target;
            },

            findItemByPath(pathStr) {
                const path = pathStr.split(',').map(Number);
                let currentLevel = GameState.program;

                for (let i = 0; i < path.length - 1; i++) {
                    if (!currentLevel[path[i]] || !currentLevel[path[i]].commands) return null;
                    currentLevel = currentLevel[path[i]].commands;
                }
                return currentLevel[path[path.length - 1]];
            },

            removeItemByPath(pathStr) {
                const path = pathStr.split(',').map(Number);
                let parentArray = GameState.program;

                if (path.length > 1) {
                    let parent = GameState.program[path[0]];
                    for (let i = 1; i < path.length - 1; i++) {
                        if (!parent || !parent.commands) return null;
                        parent = parent.commands[path[i]];
                    }
                    if (!parent || !parent.commands) return null;
                    parentArray = parent.commands;
                }

                const indexToRemove = path[path.length - 1];
                if (indexToRemove < 0 || indexToRemove >= parentArray.length) return null;
                
                return parentArray.splice(indexToRemove, 1)[0];
            },

            updateLoopCount(pathStr, value) {
                const count = parseInt(value) || CONFIG.MIN_LOOP_COUNT;
                const item = this.findItemByPath(pathStr);
                if (!item) return;
                
                item.count = Math.max(CONFIG.MIN_LOOP_COUNT, Math.min(CONFIG.MAX_LOOP_COUNT, count));
                
                const input = document.querySelector(`[data-path="${pathStr}"] .loop-count`);
                if (input) input.value = item.count;
                
                GridRenderer.updateStats();
            }
        };

        // ====================================
        // –ü–ê–õ–Ü–¢–†–ê
        // ====================================
        const PaletteManager = {
            setup() {
                document.querySelectorAll('.block[draggable="true"]').forEach(block => {
                    this.applyStyles(block);
                    
                    // –î–û–î–ê–ù–û: –û–±—Ä–æ–±–Ω–∏–∫ 'click' –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –±–ª–æ–∫—ñ–≤ (desktop —ñ fallback)
                    block.addEventListener('click', (e) => {
                        // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—é, —è–∫—â–æ —Ü–µ –±—É–≤ –∫—ñ–Ω–µ—Ü—å D&D
                        if (DragState.isDragging || GameState.isRunning) return;

                        const command = block.dataset.command;
                        let newItem;

                        if (command === 'loop') {
                            newItem = { type: 'loop', count: CONFIG.MIN_LOOP_COUNT, commands: [] };
                        } else {
                            newItem = { type: 'command', command: command };
                        }

                        // –î–æ–¥–∞—î–º–æ –≤ –∫—ñ–Ω–µ—Ü—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É
                        GameState.program.push(newItem);
                        ProgramRenderer.render();
                        HapticFeedback.medium();
                    });
                    
                    // –û–±—Ä–æ–±–Ω–∏–∫–∏ D&D –¥–ª—è –ø–∞–ª—ñ—Ç—Ä–∏
                    block.addEventListener('dragstart', (e) => {
                        if (GameState.isRunning) {
                            e.preventDefault();
                            return;
                        }
                        HapticFeedback.light();
                        const command = e.target.dataset.command;
                        let newItemData;
                        if (command === 'loop') {
                            newItemData = { type: 'loop', count: CONFIG.MIN_LOOP_COUNT, commands: [], isNew: true };
                        } else {
                            newItemData = { type: 'command', command: command, isNew: true };
                        }
                        DragState.draggedItemData = newItemData;
                        e.target.classList.add('dragging');
                        DragState.isDragging = true;
                    });

                    block.addEventListener('dragend', (e) => {
                        e.target.classList.remove('dragging');
                        DragState.cleanup();
                    });
                    
                    // –ó–ú–Ü–ù–ï–ù–û: –û–±—Ä–æ–±–Ω–∏–∫ Touch D&D (–≤—ñ–¥—Ä—ñ–∑–Ω—è—î tap/drag)
                    block.addEventListener('touchstart', (e) => {
                        if (GameState.isRunning || DragState.isDragging) return;
                        
                        const touch = e.changedTouches[0];
                        DragState.currentTouchId = touch.identifier;
                        DragState.dragTargetElement = e.target; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ü—ñ–ª—å
                        DragState.dragStartTime = Date.now();
                        DragState.dragStartPos = { x: touch.clientX, y: touch.clientY };
                        DragState.isDragPending = true; // –ß–µ–∫–∞—î–º–æ –Ω–∞ 'touchmove'
                    }, { passive: true }); // –î–æ–∑–≤–æ–ª—è—î–º–æ —Å–∫—Ä–æ–ª, –ø–æ–∫–∏ –Ω–µ –ø–æ—á–∞–≤—Å—è D&D
                });
            },

            applyStyles(block) {
                const baseStyles = 'flex items-center justify-center p-2 md:p-3 rounded-lg cursor-grab transition-all font-semibold text-white text-xs md:text-sm shadow-md hover:shadow-lg hover:scale-105 active:scale-95';
                
                if (block.classList.contains('loop')) {
                    block.className += ' ' + baseStyles + ' bg-pink-500 hover:bg-pink-600';
                } else {
                    block.className += ' ' + baseStyles + ' bg-indigo-500 hover:bg-indigo-600';
                }
            }
        };

        // ====================================
        // TUTORIAL MANAGER
        // ====================================
        const TutorialManager = {
            showStory() {
                if (GameState.storyShown) {
                    // –û–¥—Ä–∞–∑—É –¥–æ –≥—Ä–∏
                    GameState.loadLevel(0.1);
                    GridRenderer.render();
                    ProgramRenderer.render();
                    return;
                }

                // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–µ—Ä—à–∏–π –µ–∫—Ä–∞–Ω —ñ—Å—Ç–æ—Ä—ñ—ó
                document.getElementById('storyScreen1').classList.remove('hidden');
                document.getElementById('storyScreen1').classList.add('flex');
            }
        };

        // ====================================
        // –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø D&D
        // ====================================
        function initDragAndDrop() {
            const programArea = DOM.programArea;

            const getDropTarget = (e) => {
                const touch = e.touches ? e.touches[0] : null;
                const clientX = touch ? touch.clientX : e.clientX;
                const clientY = touch ? touch.clientY : e.clientY;

                const targetElement = touch ? document.elementFromPoint(clientX, clientY) : e.target;
                if (!targetElement) return null;

                const el = targetElement.closest('.loop-body, .program-area');
                if (!el) return null;

                const isLoopBody = el.classList.contains('loop-body');
                const targetPath = isLoopBody ? el.dataset.path : '';
                
                return {
                    element: el,
                    path: targetPath,
                    targetArray: ProgramDataManager.findDropTarget(targetPath)
                };
            };

            const getInsertionIndex = (e, container) => {
                const children = [...container.querySelectorAll(':scope > .program-block, :scope > .drag-placeholder')];
                const y = e.clientY || e.touches[0].clientY;
                
                let index = 0;
                for (const child of children) {
                    if (child.classList.contains('dragging')) continue; 

                    const box = child.getBoundingClientRect();
                    if (y < box.top + box.height / 2) {
                        break;
                    }
                    if (!child.classList.contains('drag-placeholder')) {
                        index++;
                    }
                }
                return index;
            };

            const updatePlaceholder = (e) => {
                const dropTarget = getDropTarget(e);
                if (!dropTarget || !dropTarget.targetArray) {
                    DragState.dragPlaceholder?.remove();
                    return;
                }

                const container = dropTarget.element;
                const index = getInsertionIndex(e, container);
                
                const children = [...container.children];
                const targetNode = children[index];

                if (targetNode === DragState.dragPlaceholder) return;
                
                if (targetNode) {
                    container.insertBefore(DragState.dragPlaceholder, targetNode);
                } else {
                    container.appendChild(DragState.dragPlaceholder);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (!DragState.draggedItemData) return;

                const dropTarget = getDropTarget(e);

                if (!dropTarget || !dropTarget.targetArray) {
                    if (!DragState.draggedItemData.isNew) {
                        ProgramDataManager.removeItemByPath(DragState.draggedItemData.path);
                        HapticFeedback.medium();
                    }
                    ProgramRenderer.render(); 
                    return;
                }

                const targetArray = dropTarget.targetArray;
                const index = getInsertionIndex(e, dropTarget.element);

                let itemToInsert;

                if (DragState.draggedItemData.isNew) {
                    itemToInsert = { ...DragState.draggedItemData };
                    delete itemToInsert.isNew;
                } else {
                    const originalPath = DragState.draggedItemData.path;
                    const originalPathParts = originalPath.split(',').map(Number);
                    const originalIndex = originalPathParts[originalPathParts.length - 1];
                    const originalParentPath = originalPathParts.slice(0, -1).join(',');
                    
                    if (dropTarget.path === originalParentPath) {
                        const adjustedIndex = (index > originalIndex) ? index - 1 : index;
                        if (adjustedIndex === originalIndex) {
                            ProgramRenderer.render(); 
                            return; 
                        }
                    }
                    
                    itemToInsert = ProgramDataManager.removeItemByPath(originalPath);
                }

                if (itemToInsert) {
                    targetArray.splice(index, 0, itemToInsert);
                    HapticFeedback.medium();
                }

                ProgramRenderer.render(); 
            };

            // ===== DESKTOP EVENTS =====
            programArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                updatePlaceholder(e);
            });

            programArea.addEventListener('dragleave', (e) => {
                if (!programArea.contains(e.relatedTarget)) {
                    DragState.dragPlaceholder?.remove();
                }
            });

            programArea.addEventListener('drop', handleDrop);
            
            document.body.addEventListener('drop', (e) => {
                if (e.target.closest('.program-area')) return; 
                handleDrop(e);
            });


            // ===== –ó–ú–Ü–ù–ï–ù–û: MOBILE TOUCH EVENTS (–≥–ª–æ–±–∞–ª—å–Ω—ñ) =====
            
            // –ó–ú–Ü–ù–ï–ù–û: 'touchmove' —Ç–µ–ø–µ—Ä –∑–∞–ø—É—Å–∫–∞—î D&D
            document.addEventListener('touchmove', (e) => {
                // –¢—ñ–ª—å–∫–∏ —è–∫—â–æ –º–∏ —á–µ–∫–∞—î–º–æ –Ω–∞ D&D (isDragPending)
                if (!DragState.isDragPending || !e.changedTouches) return;
                
                const touch = [...e.changedTouches].find(t => t.identifier === DragState.currentTouchId);
                if (!touch) return;
                
                const dx = Math.abs(touch.clientX - DragState.dragStartPos.x);
                const dy = Math.abs(touch.clientY - DragState.dragStartPos.y);

                // –Ø–∫—â–æ —Ä—É—Ö > 5px, *–ø–æ—á–∏–Ω–∞—î–º–æ* D&D
                if (dx > 5 || dy > 5) {
                    e.preventDefault(); // *–¢–µ–ø–µ—Ä* –±–ª–æ–∫—É—î–º–æ —Å–∫—Ä–æ–ª
                    DragState.isDragging = true;
                    DragState.isDragPending = false;
                    
                    const target = DragState.dragTargetElement;
                    if (!target) return;
                    
                    HapticFeedback.light();
                    
                    // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–ª–æ–Ω
                    const clone = target.cloneNode(true);
                    clone.style.position = 'fixed';
                    clone.style.zIndex = '1000';
                    clone.style.opacity = '0.8';
                    clone.style.pointerEvents = 'none';
                    clone.style.width = `${target.offsetWidth}px`;
                    document.body.appendChild(clone);
                    DragState.touchClone = clone;
                    
                    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ, —â–æ –ø–µ—Ä–µ—Ç—è–≥—É—é—Ç—å—Å—è
                    if (target.classList.contains('block')) { // –ó –ø–∞–ª—ñ—Ç—Ä–∏
                        const command = target.dataset.command;
                        DragState.draggedItemData = (command === 'loop') ?
                            { type: 'loop', count: CONFIG.MIN_LOOP_COUNT, commands: [], isNew: true } :
                            { type: 'command', command: command, isNew: true };
                    } else { // –ó –ø—Ä–æ–≥—Ä–∞–º–∏
                        DragState.draggedItemData = { path: target.dataset.path, isNew: false };
                        target.classList.add('dragging'); // "–ü—Ä–∏—Ö–æ–≤—É—î–º–æ" –æ—Ä–∏–≥—ñ–Ω–∞–ª
                    }
                    
                    DragState.moveTouchClone(touch);
                }
            }, { passive: false }); // 'passive: false' –±–æ –º–∏ *–º–æ–∂–µ–º–æ* –≤–∏–∫–ª–∏–∫–∞—Ç–∏ preventDefault

            // –ó–ú–Ü–ù–ï–ù–û: 'touchend' —Ç–µ–ø–µ—Ä –æ–±—Ä–æ–±–ª—è—î 'tap' –ê–ë–û 'drop'
            document.addEventListener('touchend', (e) => {
                if (!DragState.currentTouchId) return;
                
                const touch = [...e.changedTouches].find(t => t.identifier === DragState.currentTouchId);
                if (!touch) return;

                if (DragState.isDragPending) {
                    // –†—É—Ö—É –Ω–µ –±—É–ª–æ - —Ü–µ 'tap'
                    const target = DragState.dragTargetElement;
                    // –Ø–∫—â–æ 'tap' –±—É–≤ –Ω–∞ –ø–∞–ª—ñ—Ç—Ä—ñ, –∑–∞–ø—É—Å–∫–∞—î–º–æ "click-to-add"
                    if (target && target.classList.contains('block') && !GameState.isRunning) {
                        const command = target.dataset.command;
                        let newItem;
                        if (command === 'loop') {
                            newItem = { type: 'loop', count: CONFIG.MIN_LOOP_COUNT, commands: [] };
                        } else {
                            newItem = { type: 'command', command: command };
                        }
                        GameState.program.push(newItem);
                        ProgramRenderer.render();
                        HapticFeedback.medium();
                    }
                    // (–Ø–∫—â–æ 'tap' –±—É–≤ –Ω–∞ `.program-block`, –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ)
                
                } else if (DragState.isDragging) {
                    // –ë—É–≤ D&D, –∑–∞–ø—É—Å–∫–∞—î–º–æ 'handleDrop'
                    const fakeEvent = {
                        target: document.elementFromPoint(touch.clientX, touch.clientY),
                        clientX: touch.clientX,
                        clientY: touch.clientY,
                        touches: [touch],
                        preventDefault: () => {},
                        stopPropagation: () => {}
                    };
                    handleDrop(fakeEvent);
                }
                
                // –ó–∞–≥–∞–ª—å–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è
                DragState.cleanup(); 
                DragState.currentTouchId = null; // –û—á–∏—â—É—î–º–æ ID –≤ —Å–∞–º–æ–º—É –∫—ñ–Ω—Ü—ñ
            });
        }

        // ====================================
        // –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
        // ====================================
        document.addEventListener('DOMContentLoaded', () => {
            DOM.cache();
            DragState.init();
            initDragAndDrop(); // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –ª–æ–≥—ñ–∫—É D&D
            
            // Story –µ–∫—Ä–∞–Ω–∏
            document.getElementById('story1Next').addEventListener('click', () => {
                document.getElementById('storyScreen1').classList.add('hidden');
                document.getElementById('storyScreen2').classList.remove('hidden');
                document.getElementById('storyScreen2').classList.add('flex');
                HapticFeedback.light();
            });

            document.getElementById('story2Next').addEventListener('click', () => {
                document.getElementById('storyScreen2').classList.add('hidden');
                document.getElementById('storyScreen3').classList.remove('hidden');
                document.getElementById('storyScreen3').classList.add('flex');
                HapticFeedback.light();
            });

            document.getElementById('story3Next').addEventListener('click', () => {
                document.getElementById('storyScreen3').classList.add('hidden');
                GameState.storyShown = true;
                localStorage.setItem('storyShown', 'true');
                GameState.loadLevel(0.1);
                GridRenderer.render();
                ProgramRenderer.render();
                HapticFeedback.medium();
            });

            // –ü–æ–∫–∞–∑–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –∞–±–æ –æ–¥—Ä–∞–∑—É –≥—Ä—É
            TutorialManager.showStory();

            PaletteManager.setup(); // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –ø–∞–ª—ñ—Ç—Ä—É (—Ç–µ–ø–µ—Ä –∑ click + D&D)

            // –ö–Ω–æ–ø–∫–∏
            document.querySelector('.run-btn').addEventListener('click', () => ProgramExecutor.run());
            document.querySelector('.reset-btn').addEventListener('click', () => {
                GameState.reset(true);
                GridRenderer.render();
                ModalManager.hide();
                HapticFeedback.light();
            });
            document.querySelector('.clear-btn').addEventListener('click', () => {
                if (GameState.program.length > 0) {
                    GameState.program = [];
                    ProgramRenderer.render();
                    HapticFeedback.light();
                }
            });

            document.getElementById('prevLevel').addEventListener('click', () => LevelManager.loadPrev());
            document.getElementById('nextLevel').addEventListener('click', () => LevelManager.loadNext());
            document.getElementById('showHint').addEventListener('click', () => {
                const level = LEVELS[GameState.currentLevel];
                const hint = level.hint || level.tutorialText || "–°–ø—Ä–æ–±—É–π—Ç–µ —Ä—ñ–∑–Ω—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏!";
                if (GameState.isTutorialMode && level.tutorialText) {
                     ModalManager.show('üí° –ü—ñ–¥–∫–∞–∑–∫–∞', level.tutorialText, 'success');
                } else {
                     ModalManager.show('üí° –ü—ñ–¥–∫–∞–∑–∫–∞', hint, 'success');
                }
                HapticFeedback.light();
            });

            console.log('üéÆ –ö–æ–¥–µ–≥–æ—Ä–æ—à–∫–æ –∑–∞–ø—É—â–µ–Ω–æ!');
        });
    </script>
</body>
</html>

